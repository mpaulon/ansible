---
- name: "Install bind9"
  apt:
    update_cache: True
    name:
      - bind9
    state: present
  register: apt_result
  retries: 3
  until: apt_result is succeeded

- name: Deploy config
  template:
    src: 'etc/bind/{{ item.src }}'
    dest: '/etc/bind/{{ item.dest }}'
    owner: root
    group: bind
  with_items:
    - { src: 'named.conf.local.j2', dest: 'named.conf.local' }
  notify: Restart bind

- name: deploy zones
  template:
    src: "var/cache/bind/db.{{ item }}.j2"
    dest: "/var/cache/bind/db.{{ item }}"
    owner: root
    group: bind
  when:
    - (zones[item].master)
  loop: "{{ zones.keys() }}"
  notify: Restart bind

- name: deploy acme zones
  template:
    src: "var/cache/bind/db.acme.j2"
    dest: "/var/cache/bind/db._acme-challenge.{{ item }}"
    owner: root
    group: bind
  when:
    - (zones[item].master and global_zones[item].get("acme"))
  loop: "{{ zones.keys() }}"
  notify: Restart bind
